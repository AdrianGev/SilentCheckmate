<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SilentCheckmate - Chess Client</title>
    <script type="module" src="https://unpkg.com/chessboard-element?module"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .game-controls {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }
        .game-info {
            margin: 20px 0;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 480px;
        }
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .login-error {
            color: red;
            display: none;
        }
        .game-screen {
            display: none;
        }
        .server-settings {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .settings-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .move-list {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
        /* Game result popup */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .popup {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .popup h2 {
            margin-top: 0;
            color: #333;
        }
        .popup p {
            margin: 15px 0;
            font-size: 16px;
        }
        .popup-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .popup-buttons button {
            padding: 8px 16px;
            cursor: pointer;
        }
        .draw-button {
            background-color: #f0ad4e;
            color: white;
            border: none;
            border-radius: 4px;
            margin-left: 10px;
        }
        .draw-button:hover {
            background-color: #ec971f;
        }
        
        /* Time control styles */
        .time-control-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            width: 300px;
        }
        
        .time-control-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .time-control-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .time-control-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        /* Chess clock styles */
        .chess-clocks {
            display: none;
            justify-content: space-between;
            margin: 10px 0;
            width: 480px;
        }
        
        .clock {
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            width: 48%;
        }
        
        .clock-active {
            background-color: #e8f5e9;
        }
        
        .clock-low {
            color: red;
        }
        
        .clock-time {
            font-size: 24px;
            font-weight: bold;
            font-family: monospace;
        }
        
        .clock-player {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 90;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SilentCheckmate</h1>
            <button id="settings-btn">Server Settings</button>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="login-screen">
            <h2>Login</h2>
            <form id="login-form" class="login-form">
                <div>
                    <label for="username">Username:</label>
                    <input type="text" id="username" required>
                </div>
                <div id="login-error" class="login-error"></div>
                <button type="submit">Enter</button>
            </form>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="game-screen">
            <div id="player-info">Player: Guest</div>
            
            <div class="game-controls">
                <button id="create-game-btn">Create Game</button>
                <input id="join-game-id" placeholder="Game ID">
                <button id="join-game-btn">Join Game</button>
                <button id="reset-btn">Reset Board</button>
                <button id="resign-btn" disabled>Resign</button>
                <button id="offer-draw-btn" disabled class="draw-button">Offer Draw</button>
            </div>
            
            <!-- Chess Clocks -->
            <div id="chess-clocks" class="chess-clocks">
                <div id="opponent-clock" class="clock">
                    <div id="opponent-name" class="clock-player">Opponent</div>
                    <div id="opponent-time" class="clock-time">10:00</div>
                </div>
                <div id="player-clock" class="clock">
                    <div id="player-name" class="clock-player">You</div>
                    <div id="player-time" class="clock-time">10:00</div>
                </div>
            </div>
            
            <chess-board id="board"
                style="width: 480px;"
                draggable-pieces="true"
                position="start">
            </chess-board>
            
            <div class="game-info">
                <div id="status" class="status">Ready to play</div>
                <div id="game-id"></div>
                <div>
                    <h3>Move History</h3>
                    <div id="move-list" class="move-list"></div>
                </div>
            </div>
        </div>

        <!-- Server Settings -->
        <div id="server-settings" class="server-settings">
            <h3>Server Settings</h3>
            <div>
                <label>
                    Server URL:
                    <input type="text" id="server-url" placeholder="https://silentcheckmate.onrender.com (no port needed)">
                </label>
            </div>
            <div class="settings-buttons">
                <button id="save-settings-btn">Save</button>
                <button id="cancel-settings-btn">Cancel</button>
            </div>
        </div>
        
        <!-- Time Control Dialog -->
        <div id="overlay" class="overlay"></div>
        <div id="time-control-dialog" class="time-control-dialog">
            <h3>Time Control Settings</h3>
            <form id="time-control-form" class="time-control-form">
                <div class="form-group">
                    <label for="time-minutes">Time (minutes)</label>
                    <input type="number" id="time-minutes" min="1" max="60" value="10" required>
                </div>
                <div class="form-group">
                    <label for="time-increment">Increment (seconds)</label>
                    <input type="number" id="time-increment" min="0" max="60" value="0" required>
                </div>
                <div class="time-control-buttons">
                    <button type="submit" id="create-timed-game-btn">Create Game</button>
                    <button type="button" id="cancel-time-control-btn">Cancel</button>
                </div>
            </form>
        </div>
        
        <!-- Game Result Popup -->
        <div id="result-popup" class="popup-overlay">
            <div class="popup">
                <h2 id="result-title">Game Over</h2>
                <p id="result-message">The game has ended.</p>
                <div class="popup-buttons">
                    <button id="new-game-btn">New Game</button>
                    <button id="close-popup-btn">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Draw Offer Popup -->
        <div id="draw-popup" class="popup-overlay">
            <div class="popup">
                <h2>Draw Offered</h2>
                <p id="draw-message">Your opponent has offered a draw.</p>
                <div class="popup-buttons">
                    <button id="accept-draw-btn">Accept</button>
                    <button id="decline-draw-btn">Decline</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let username = '';
        let gameId = '';
        let isGameActive = false;
        
        // Time control variables
        let isTimedGame = false;
        let playerColor = 'white';
        let playerClock = null;
        let opponentClock = null;
        let timeMinutes = 10;
        let timeIncrement = 0;
        let activePlayer = 'white';
        let clockInterval = null;
        
        // Get server URL from localStorage or use default
        function getServerUrl() {
            return localStorage.getItem('SERVER_URL') || 'https://silentcheckmate.onrender.com';
        }
        
        // Initialize WebSocket connection
        function connect() {
            const SERVER = getServerUrl();
            const WSURL = SERVER.replace(/^http/, m => m === "https" ? "wss" : "ws") + "/ws";
            
            if (socket && socket.readyState === 1) socket.close();
            
            socket = new WebSocket(WSURL);
            
            socket.onopen = () => {
                console.log("WebSocket connected");
                updateStatus("Connected to server");
                
                // If already logged in, join game
                if (username && gameId) {
                    socket.send(JSON.stringify({ t: "JOIN", gameId }));
                }
                
                // Keep-alive for free tier
                socket.pingInterval = setInterval(() => {
                    if (socket.readyState === 1) {
                        socket.send(JSON.stringify({ t: "PING" }));
                    }
                }, 25000);
            };
            
            socket.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                console.log("Received message:", msg);
                
                if (msg.t === "STATE") {
                    console.log("STATE", msg.fen, "last:", msg.last, "activePlayer:", msg.activePlayer);
                    const board = document.getElementById("board");
                    board.setAttribute("position", msg.fen); // update from server
                    
                    if (msg.last) {
                        addMoveToHistory(msg.last);
                        updateStatus(`Last move: ${msg.last}`);
                    }
                    
                    // Handle clock updates if this is a timed game
                    if (isTimedGame && msg.activePlayer) {
                        updateClockAfterMove(msg.activePlayer, msg.whiteTime, msg.blackTime);
                    }
                }
                
                if (msg.t === "ILLEGAL") {
                    console.warn("ILLEGAL move");
                    updateStatus("Illegal move attempted");
                }
                
                // Handle legacy message format
                if (msg.type) {
                    handleLegacyMessage(msg);
                }
            };
            
            socket.onclose = () => {
                console.log("WebSocket disconnected");
                updateStatus("Disconnected from server. Reconnecting...");
                clearInterval(socket.pingInterval);
                setTimeout(connect, 2000);
            };
            
            socket.onerror = (e) => {
                console.error("WebSocket error:", e);
                updateStatus("Connection error");
                socket.close();
            };
        }
        
        // Handle legacy message format
        function handleLegacyMessage(msg) {
            const { type, payload, timestamp } = msg;
            
            switch (type) {
                case 'CONNECTED':
                    console.log('Connected to server:', payload);
                    updateStatus('Connected to server');
                    break;
                    
                case 'LOGIN_SUCCESS':
                    console.log('Login successful:', payload);
                    break;
                    
                case 'GAME_CREATED':
                    console.log('Game created:', payload);
                    gameId = payload.gameId;
                    document.getElementById('game-id').textContent = `Game ID: ${gameId}`;
                    
                    // Check if this is a timed game
                    if (payload.timeControl) {
                        timeMinutes = payload.timeControl.minutes;
                        timeIncrement = payload.timeControl.increment;
                        updateStatus(`Game created with ${timeMinutes} min + ${timeIncrement} sec increment. Share ID ${gameId} with your opponent.`);
                        
                        // Initialize clocks
                        initializeClocks(timeMinutes);
                    } else {
                        updateStatus(`Game created. Share ID ${gameId} with your opponent.`);
                        document.getElementById('chess-clocks').style.display = 'none';
                    }
                    
                    // Set player color and board orientation
                    playerColor = 'white';
                    let gameBoard = document.getElementById('board');
                    gameBoard.setAttribute('orientation', 'white');
                    document.getElementById('player-name').textContent = username + ' (White)';
                    document.getElementById('opponent-name').textContent = 'Waiting for opponent...';
                    
                    // Join the game room
                    socket.send(JSON.stringify({ t: "JOIN", gameId }));
                    
                    // Enable/disable buttons
                    document.getElementById('create-game-btn').disabled = true;
                    document.getElementById('join-game-btn').disabled = true;
                    document.getElementById('join-game-id').disabled = true;
                    document.getElementById('resign-btn').disabled = false;
                    document.getElementById('offer-draw-btn').disabled = false;
                    break;
                    
                case 'GAME_JOINED':
                    console.log('Game joined:', payload);
                    gameId = payload.gameId;
                    document.getElementById('game-id').textContent = `Game ID: ${gameId}`;
                    
                    // Check if this is a timed game
                    if (payload.timeControl) {
                        isTimedGame = true;
                        timeMinutes = payload.timeControl.minutes;
                        timeIncrement = payload.timeControl.increment;
                        updateStatus(`Joined game ${gameId} with ${timeMinutes} min + ${timeIncrement} sec increment. Playing as ${payload.color}.`);
                        
                        // Initialize clocks
                        initializeClocks(timeMinutes);
                        console.log('Clock initialized for joining player, isTimedGame:', isTimedGame);
                    } else {
                        isTimedGame = false;
                        updateStatus(`Joined game ${gameId}. Playing as ${payload.color}.`);
                        document.getElementById('chess-clocks').style.display = 'none';
                    }
                    
                    // Join the game room
                    socket.send(JSON.stringify({ t: "JOIN", gameId }));
                    
                    // Enable/disable buttons
                    document.getElementById('create-game-btn').disabled = true;
                    document.getElementById('join-game-btn').disabled = true;
                    document.getElementById('join-game-id').disabled = true;
                    document.getElementById('resign-btn').disabled = false;
                    document.getElementById('offer-draw-btn').disabled = !isGameActive;
                    
                    isGameActive = true;
                    
                    // Set player color and update clock labels
                    playerColor = payload.color;
                    let joinBoard = document.getElementById('board');
                    console.log('Setting board orientation for', payload.color, 'player');
                    if (payload.color === 'black') {
                        joinBoard.setAttribute('orientation', 'black');
                        document.getElementById('player-name').textContent = username + ' (Black)';
                        document.getElementById('opponent-name').textContent = payload.opponent + ' (White)';
                        console.log('Board orientation set to black');
                    } else {
                        joinBoard.setAttribute('orientation', 'white');
                        document.getElementById('player-name').textContent = username + ' (White)';
                        document.getElementById('opponent-name').textContent = payload.opponent + ' (Black)';
                        console.log('Board orientation set to white');
                    }
                    break;
                    
                case 'OPPONENT_JOINED':
                    console.log('Opponent joined:', payload);
                    updateStatus(`${payload.opponent} joined the game. Your turn.`);
                    isGameActive = true;
                    document.getElementById('offer-draw-btn').disabled = false;
                    
                    // Update opponent name in clock
                    if (playerColor === 'white') {
                        document.getElementById('opponent-name').textContent = payload.opponent + ' (Black)';
                    } else {
                        document.getElementById('opponent-name').textContent = payload.opponent + ' (White)';
                    }
                    
                    // Start the clock if this is a timed game
                    if (isTimedGame) {
                        startClock('white'); // White always moves first
                    }
                    break;
                    
                case 'GAME_OVER':
                    console.log('Game over:', payload);
                    isGameActive = false;
                    
                    // Stop the clock if it's running
                    if (clockInterval) {
                        clearInterval(clockInterval);
                        clockInterval = null;
                    }
                    
                    let message = '';
                    let title = 'Game Over';
                    
                    if (payload.reason === 'checkmate') {
                        if (payload.winner === username) {
                            title = 'You Won!';
                            message = `You won by checkmate against ${payload.loser || 'opponent'}!`;
                        } else {
                            title = 'You Lost';
                            message = `${payload.winner} won by checkmate.`;
                        }
                    } else if (payload.reason === 'resignation') {
                        if (payload.winner === username) {
                            title = 'You Won!';
                            message = `${payload.loser} resigned. You win!`;
                        } else {
                            title = 'You Lost';
                            message = `You resigned. ${payload.winner} wins.`;
                        }
                    } else if (payload.reason === 'timeout') {
                        if (payload.winner === username) {
                            title = 'You Won!';
                            message = `${payload.loser} ran out of time. You win!`;
                        } else {
                            title = 'You Lost';
                            message = `You ran out of time. ${payload.winner} wins.`;
                        }
                    } else if (payload.reason === 'draw') {
                        title = 'Draw';
                        message = 'Game ended in a draw.';
                    } else if (payload.reason === 'stalemate') {
                        title = 'Draw';
                        message = 'Game ended in stalemate.';
                    } else if (payload.reason === 'draw_agreement') {
                        title = 'Draw';
                        message = 'Game ended by mutual agreement.';
                    } else {
                        if (payload.winner === username) {
                            title = 'You Won!';
                            message = `You won against ${payload.loser || 'opponent'}!`;
                        } else {
                            title = 'You Lost';
                            message = `${payload.winner} won the game.`;
                        }
                    }
                    
                    updateStatus(message);
                    showGameResultPopup(title, message);
                    
                    // Enable/disable buttons
                    document.getElementById('create-game-btn').disabled = false;
                    document.getElementById('join-game-btn').disabled = false;
                    document.getElementById('join-game-id').disabled = false;
                    document.getElementById('resign-btn').disabled = true;
                    document.getElementById('offer-draw-btn').disabled = true;
                    break;
                    
                case 'DRAW_OFFERED':
                    console.log('Draw offered:', payload);
                    showDrawOfferPopup(payload.offeredBy);
                    updateStatus(`${payload.offeredBy} offered a draw.`);
                    break;
                    
                case 'DRAW_DECLINED':
                    console.log('Draw declined:', payload);
                    updateStatus(`${payload.declinedBy} declined the draw offer.`);
                    break;
                    
                case 'OPPONENT_DISCONNECTED':
                    console.log('Opponent disconnected:', payload);
                    updateStatus(`${payload.opponent} has disconnected.`);
                    
                    // Enable/disable buttons
                    document.getElementById('create-game-btn').disabled = false;
                    document.getElementById('join-game-btn').disabled = false;
                    document.getElementById('join-game-id').disabled = false;
                    document.getElementById('resign-btn').disabled = true;
                    
                    isGameActive = false;
                    break;
                    
                case 'ERROR':
                    console.error('Error from server:', payload);
                    updateStatus(`Error: ${payload.message}`);
                    break;
                    
                default:
                    console.log('Unknown message type:', type);
            }
        }
        
        // Update status message
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Add move to history
        function addMoveToHistory(move) {
            const moveListEl = document.getElementById('move-list');
            const moveItem = document.createElement('div');
            moveItem.textContent = move;
            moveListEl.appendChild(moveItem);
            
            // Scroll to bottom
            moveListEl.scrollTop = moveListEl.scrollHeight;
        }
        
        // Update server URL
        function updateServerUrl() {
            const serverUrlInput = document.getElementById('server-url');
            const newUrl = serverUrlInput.value.trim();
            
            if (newUrl) {
                localStorage.setItem('SERVER_URL', newUrl);
                
                // Close existing socket
                if (socket) {
                    if (socket.pingInterval) {
                        clearInterval(socket.pingInterval);
                    }
                    socket.close();
                }
                
                // Reconnect with new URL
                connect();
                
                // Hide settings
                document.getElementById('server-settings').style.display = 'none';
            }
        }
        
        // Show game result popup
        function showGameResultPopup(title, message) {
            document.getElementById('result-title').textContent = title;
            document.getElementById('result-message').textContent = message;
            const popup = document.getElementById('result-popup');
            popup.style.display = 'flex';
        }
        
        // Show draw offer popup
        function showDrawOfferPopup(opponent) {
            document.getElementById('draw-message').textContent = `${opponent} has offered a draw.`;
            const popup = document.getElementById('draw-popup');
            popup.style.display = 'flex';
        }
        
        // DOM ready handler
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded');
            
            // Initialize WebSocket connection
            connect();
            
            // Server settings
            const settingsBtn = document.getElementById('settings-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
            const serverUrlInput = document.getElementById('server-url');
            
            settingsBtn.addEventListener('click', () => {
                serverUrlInput.value = getServerUrl();
                document.getElementById('server-settings').style.display = 'block';
            });
            
            saveSettingsBtn.addEventListener('click', updateServerUrl);
            
            cancelSettingsBtn.addEventListener('click', () => {
                document.getElementById('server-settings').style.display = 'none';
            });
            
            // Game result popup buttons
            document.getElementById('new-game-btn').addEventListener('click', () => {
                document.getElementById('result-popup').style.display = 'none';
                document.getElementById('create-game-btn').click();
            });
            
            document.getElementById('close-popup-btn').addEventListener('click', () => {
                document.getElementById('result-popup').style.display = 'none';
            });
            
            // Draw offer popup buttons
            document.getElementById('accept-draw-btn').addEventListener('click', () => {
                document.getElementById('draw-popup').style.display = 'none';
                if (socket && socket.readyState === WebSocket.OPEN && gameId) {
                    socket.send(JSON.stringify({ type: 'ACCEPT_DRAW', payload: { gameId } }));
                }
            });
            
            document.getElementById('decline-draw-btn').addEventListener('click', () => {
                document.getElementById('draw-popup').style.display = 'none';
                if (socket && socket.readyState === WebSocket.OPEN && gameId) {
                    socket.send(JSON.stringify({ type: 'DECLINE_DRAW', payload: { gameId } }));
                }
            });
            
            // Offer draw button
            document.getElementById('offer-draw-btn').addEventListener('click', () => {
                if (!gameId || !isGameActive) {
                    updateStatus('No active game');
                    return;
                }
                
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'OFFER_DRAW', payload: { gameId } }));
                    updateStatus('Draw offered to opponent');
                } else {
                    updateStatus('Not connected to server');
                }
            });
            
            // Login form
            const loginForm = document.getElementById('login-form');
            const usernameInput = document.getElementById('username');
            const loginError = document.getElementById('login-error');
            const loginScreen = document.getElementById('login-screen');
            const gameScreen = document.getElementById('game-screen');
            
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const usernameValue = usernameInput.value.trim();
                
                if (!usernameValue) {
                    loginError.textContent = 'Please enter a username';
                    loginError.style.display = 'block';
                    return;
                }
                
                username = usernameValue;
                document.getElementById('player-info').textContent = `Player: ${username}`;
                
                // Hide login screen, show game screen
                loginScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                
                // Send login message if connected
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'LOGIN', payload: { username } }));
                }
            });
            
            // Game control buttons
            const createGameBtn = document.getElementById('create-game-btn');
            const joinGameIdInput = document.getElementById('join-game-id');
            const joinGameBtn = document.getElementById('join-game-btn');
            const resetBtn = document.getElementById('reset-btn');
            const resignBtn = document.getElementById('resign-btn');
            
            createGameBtn.addEventListener('click', () => {
                if (!username) {
                    updateStatus('Please enter a username first');
                    return;
                }
                
                // Show time control dialog
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('time-control-dialog').style.display = 'block';
            });
            
            // Time control form handling
            const timeControlForm = document.getElementById('time-control-form');
            const cancelTimeControlBtn = document.getElementById('cancel-time-control-btn');
            
            timeControlForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                // Get time control values
                timeMinutes = parseInt(document.getElementById('time-minutes').value, 10);
                timeIncrement = parseInt(document.getElementById('time-increment').value, 10);
                
                if (isNaN(timeMinutes) || timeMinutes < 1) {
                    alert('Please enter a valid time in minutes');
                    return;
                }
                
                if (isNaN(timeIncrement) || timeIncrement < 0) {
                    alert('Please enter a valid increment in seconds');
                    return;
                }
                
                // Hide dialog
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('time-control-dialog').style.display = 'none';
                
                // Create game with time control
                if (socket && socket.readyState === WebSocket.OPEN) {
                    isTimedGame = true;
                    socket.send(JSON.stringify({ 
                        type: 'CREATE_GAME', 
                        payload: { 
                            timeControl: {
                                minutes: timeMinutes,
                                increment: timeIncrement
                            }
                        } 
                    }));
                } else {
                    updateStatus('Not connected to server');
                }
            });
            
            cancelTimeControlBtn.addEventListener('click', () => {
                // Hide dialog
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('time-control-dialog').style.display = 'none';
                
                // Create regular game without time control
                if (socket && socket.readyState === WebSocket.OPEN) {
                    isTimedGame = false;
                    socket.send(JSON.stringify({ type: 'CREATE_GAME', payload: {} }));
                } else {
                    updateStatus('Not connected to server');
                }
            });
            
            joinGameBtn.addEventListener('click', () => {
                if (!username) {
                    updateStatus('Please enter a username first');
                    return;
                }
                
                const joinGameId = joinGameIdInput.value.trim();
                
                if (!joinGameId) {
                    updateStatus('Please enter a game ID');
                    return;
                }
                
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'JOIN_GAME', payload: { gameId: joinGameId } }));
                    gameId = joinGameId;
                } else {
                    updateStatus('Not connected to server');
                }
            });
            
            resetBtn.addEventListener('click', () => {
                const board = document.getElementById('board');
                board.setAttribute('position', 'start');
                updateStatus('Board reset to starting position');
            });
            
            resignBtn.addEventListener('click', () => {
                if (!gameId) {
                    updateStatus('No active game');
                    return;
                }
                
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'RESIGN', payload: { gameId } }));
                } else {
                    updateStatus('Not connected to server');
                }
            });
            
            // Drag-drop → send MOVE to server
            const board = document.getElementById('board');
            board.addEventListener('drop', (e) => {
                const { source, target, setAction } = e.detail;
                setAction('snapback'); // don't move locally; trust server STATE
                
                if (!socket || socket.readyState !== 1) {
                    updateStatus('Not connected to server');
                    return;
                }
                
                if (!gameId) {
                    // Allow moves in test mode
                    return;
                }
                
                console.log('Sending move:', source, 'to', target, 'gameId:', gameId);
                socket.send(JSON.stringify({ 
                    t: "MOVE", 
                    gameId, 
                    from: source, 
                    to: target, 
                    promo: "q" 
                }));
            });
            
            // Chess clock functions
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${minutes}:${secs < 10 ? '0' + secs : secs}`;
            }
            
            function initializeClocks(minutes) {
                console.log('Initializing clocks with', minutes, 'minutes');
                const totalSeconds = minutes * 60;
                playerClock = totalSeconds;
                opponentClock = totalSeconds;
                
                document.getElementById('player-time').textContent = formatTime(playerClock);
                document.getElementById('opponent-time').textContent = formatTime(opponentClock);
                
                // Make sure clocks are visible for timed games
                const clocksElement = document.getElementById('chess-clocks');
                clocksElement.style.display = 'flex';
                console.log('Clocks display set to flex, current style:', clocksElement.style.display);
            }
            
            function startClock(color) {
                // Clear any existing interval
                if (clockInterval) {
                    clearInterval(clockInterval);
                    clockInterval = null;
                }
                
                activePlayer = color;
                
                // Update active clock visual
                const playerClockElement = document.getElementById('player-clock');
                const opponentClockElement = document.getElementById('opponent-clock');
                
                if ((playerColor === 'white' && color === 'white') || 
                    (playerColor === 'black' && color === 'black')) {
                    playerClockElement.classList.add('clock-active');
                    opponentClockElement.classList.remove('clock-active');
                } else {
                    opponentClockElement.classList.add('clock-active');
                    playerClockElement.classList.remove('clock-active');
                }
                
                clockInterval = setInterval(() => {
                    if (!isGameActive) {
                        clearInterval(clockInterval);
                        clockInterval = null;
                        return;
                    }
                    
                    // Determine whose clock to decrement
                    if ((playerColor === 'white' && color === 'white') || 
                        (playerColor === 'black' && color === 'black')) {
                        playerClock--;
                        document.getElementById('player-time').textContent = formatTime(playerClock);
                        
                        // Check for time out
                        if (playerClock <= 0) {
                            clearInterval(clockInterval);
                            clockInterval = null;
                            timeOut(playerColor);
                        }
                        
                        // Add low time warning
                        if (playerClock <= 30) {
                            document.getElementById('player-time').classList.add('clock-low');
                        }
                    } else {
                        opponentClock--;
                        document.getElementById('opponent-time').textContent = formatTime(opponentClock);
                        
                        // Check for time out
                        if (opponentClock <= 0) {
                            clearInterval(clockInterval);
                            clockInterval = null;
                            timeOut(color);
                        }
                        
                        // Add low time warning
                        if (opponentClock <= 30) {
                            document.getElementById('opponent-time').classList.add('clock-low');
                        }
                    }
                }, 1000);
            }
            
            function updateClockAfterMove(newActivePlayer, whiteTime, blackTime) {
                // If server sent time values, use them
                if (whiteTime !== undefined && blackTime !== undefined) {
                    if (playerColor === 'white') {
                        playerClock = whiteTime;
                        opponentClock = blackTime;
                    } else {
                        playerClock = blackTime;
                        opponentClock = whiteTime;
                    }
                    
                    document.getElementById('player-time').textContent = formatTime(playerClock);
                    document.getElementById('opponent-time').textContent = formatTime(opponentClock);
                } else {
                    // Add increment to the player who just moved
                    const previousPlayer = newActivePlayer === 'white' ? 'black' : 'white';
                    
                    if (playerColor === previousPlayer) {
                        playerClock += timeIncrement;
                        document.getElementById('player-time').textContent = formatTime(playerClock);
                    } else {
                        opponentClock += timeIncrement;
                        document.getElementById('opponent-time').textContent = formatTime(opponentClock);
                    }
                }
                
                // Start the clock for the new active player
                startClock(newActivePlayer);
            }
            
            function timeOut(color) {
                // Determine winner
                const winner = color === playerColor ? 'opponent' : 'player';
                const winnerName = winner === 'player' ? username : document.getElementById('opponent-name').textContent.split(' ')[0];
                const loserName = winner === 'player' ? document.getElementById('opponent-name').textContent.split(' ')[0] : username;
                
                // Send timeout message to server
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ 
                        type: 'TIMEOUT', 
                        payload: { 
                            gameId,
                            winner: winnerName,
                            loser: loserName
                        } 
                    }));
                }
                
                isGameActive = false;
            }
        });
    </script>
</body>
</html>
