<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SilentCheckmate - Chess Client</title>
    <script type="module" src="https://unpkg.com/chessboard-element?module"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .game-controls {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }
        .game-info {
            margin: 20px 0;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 480px;
        }
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .login-error {
            color: red;
            display: none;
        }
        .game-screen {
            display: none;
        }
        .server-settings {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .settings-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .move-list {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
        /* Game result popup */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .popup {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .popup h2 {
            margin-top: 0;
            color: #333;
        }
        .popup p {
            margin: 15px 0;
            font-size: 16px;
        }
        .popup-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .popup-buttons button {
            padding: 8px 16px;
            cursor: pointer;
        }
        .draw-button {
            background-color: #f0ad4e;
            color: white;
            border: none;
            border-radius: 4px;
            margin-left: 10px;
        }
        .draw-button:hover {
            background-color: #ec971f;
        }
        
        /* ELO Rating Styles */
        .player-profile {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 480px;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            background-color: #ddd;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #666;
        }
        
        .player-details {
            display: flex;
            flex-direction: column;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .player-elo {
            font-size: 14px;
            color: #666;
        }
        
        .elo-badge {
            background-color: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .logout-btn {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background-color: #d32f2f;
        }
        
        .leaderboard {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 480px;
        }
        
        .leaderboard h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .leaderboard-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .leaderboard-rank {
            font-weight: bold;
            width: 30px;
        }
        
        .leaderboard-username {
            flex-grow: 1;
        }
        
        .leaderboard-elo {
            font-weight: bold;
        }
        
        .match-history {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 480px;
        }
        
        .match-history h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .match-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .match-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .match-result {
            font-weight: bold;
            width: 60px;
        }
        
        .match-result.win {
            color: #4CAF50;
        }
        
        .match-result.loss {
            color: #f44336;
        }
        
        .match-result.draw {
            color: #ff9800;
        }
        
        .match-opponent {
            flex-grow: 1;
        }
        
        .match-elo-change {
            font-weight: bold;
        }
        
        .match-elo-change.positive {
            color: #4CAF50;
        }
        
        .match-elo-change.negative {
            color: #f44336;
        }
        
        .tabs {
            display: flex;
            margin-top: 20px;
            border-bottom: 1px solid #ddd;
            width: 480px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SilentCheckmate</h1>
            <button id="settings-btn">Server Settings</button>
        </div>

        <!-- Login Screen - Redirect to login.html -->
        <div id="login-screen" class="login-screen">
            <h2>Redirecting to Login...</h2>
            <p>Please wait while we redirect you to the login page.</p>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="game-screen">
            <div class="player-profile">
                <div class="player-info">
                    <div class="player-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="player-details">
                        <div id="player-name" class="player-name">Guest</div>
                        <div id="player-elo" class="player-elo">ELO: --</div>
                    </div>
                </div>
                <div>
                    <span id="elo-badge" class="elo-badge">--</span>
                    <button id="logout-btn" class="logout-btn">Logout</button>
                </div>
            </div>
            
            <div class="game-controls">
                <button id="create-game-btn">Create Game</button>
                <input id="join-game-id" placeholder="Game ID">
                <button id="join-game-btn">Join Game</button>
                <button id="reset-btn">Reset Board</button>
                <button id="resign-btn" disabled>Resign</button>
                <button id="offer-draw-btn" disabled class="draw-button">Offer Draw</button>
            </div>
            
            <chess-board id="board"
                style="width: 480px;"
                draggable-pieces="true"
                position="start">
            </chess-board>
            
            <div class="game-info">
                <div id="status" class="status">Ready to play</div>
                <div id="game-id"></div>
                <div>
                    <h3>Move History</h3>
                    <div id="move-list" class="move-list"></div>
                </div>
            </div>
            
            <!-- Tabs for Stats, Leaderboard, Match History -->
            <div class="tabs">
                <div class="tab active" data-tab="game-tab">Game</div>
                <div class="tab" data-tab="leaderboard-tab">Leaderboard</div>
                <div class="tab" data-tab="history-tab">Match History</div>
            </div>
            
            <!-- Tab Content -->
            <div id="game-tab" class="tab-content active">
                <!-- Game content is already shown above -->
            </div>
            
            <div id="leaderboard-tab" class="tab-content">
                <div class="leaderboard">
                    <h3>Top Players</h3>
                    <ul id="leaderboard-list" class="leaderboard-list">
                        <li class="leaderboard-item">
                            <span class="leaderboard-rank">1.</span>
                            <span class="leaderboard-username">Loading...</span>
                            <span class="leaderboard-elo">--</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div id="history-tab" class="tab-content">
                <div class="match-history">
                    <h3>Your Match History</h3>
                    <ul id="match-list" class="match-list">
                        <li class="match-item">
                            <span class="match-result">Loading...</span>
                            <span class="match-opponent">--</span>
                            <span class="match-elo-change">--</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Server Settings -->
        <div id="server-settings" class="server-settings">
            <h3>Server Settings</h3>
            <div>
                <label>
                    Server URL:
                    <input type="text" id="server-url" placeholder="https://silentcheckmate.onrender.com (no port needed)">
                </label>
            </div>
            <div class="settings-buttons">
                <button id="save-settings-btn">Save</button>
                <button id="cancel-settings-btn">Cancel</button>
            </div>
        </div>
        
        <!-- Game Result Popup -->
        <div id="result-popup" class="popup-overlay">
            <div class="popup">
                <h2 id="result-title">Game Over</h2>
                <p id="result-message">The game has ended.</p>
                <div class="popup-buttons">
                    <button id="new-game-btn">New Game</button>
                    <button id="close-popup-btn">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Draw Offer Popup -->
        <div id="draw-popup" class="popup-overlay">
            <div class="popup">
                <h2>Draw Offered</h2>
                <p id="draw-message">Your opponent has offered a draw.</p>
                <div class="popup-buttons">
                    <button id="accept-draw-btn">Accept</button>
                    <button id="decline-draw-btn">Decline</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let username = '';
        let gameId = '';
        let isGameActive = false;
        let user = null;
        const apiUrl = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001/api' 
            : 'https://silentcheckmate.onrender.com/api';
        
        // Get server URL from localStorage or use default
        function getServerUrl() {
            return localStorage.getItem('SERVER_URL') || 'https://silentcheckmate.onrender.com';
        }
        
        // Initialize WebSocket connection
        function connect() {
            const SERVER = getServerUrl();
            const WSURL = SERVER.replace(/^http/, m => m === "https" ? "wss" : "ws") + "/ws";
            
            if (socket && socket.readyState === 1) socket.close();
            
            socket = new WebSocket(WSURL);
            
            socket.onopen = () => {
                console.log("WebSocket connected");
                updateStatus("Connected to server");
                
                // If already logged in, join game
                if (username && gameId) {
                    socket.send(JSON.stringify({ t: "JOIN", gameId }));
                }
                
                // Keep-alive for free tier
                socket.pingInterval = setInterval(() => {
                    if (socket.readyState === 1) {
                        socket.send(JSON.stringify({ t: "PING" }));
                    }
                }, 25000);
            };
            
            socket.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                console.log("Received message:", msg);
                
                if (msg.t === "STATE") {
                    console.log("STATE", msg.fen, "last:", msg.last);
                    const board = document.getElementById("board");
                    board.setAttribute("position", msg.fen); // update from server
                    
                    if (msg.last) {
                        addMoveToHistory(msg.last);
                        updateStatus(`Last move: ${msg.last}`);
                    }
                }
                
                if (msg.t === "ILLEGAL") {
                    console.warn("ILLEGAL move");
                    updateStatus("Illegal move attempted");
                }
                
                // Handle legacy message format
                if (msg.type) {
                    handleLegacyMessage(msg);
                }
            };
            
            socket.onclose = () => {
                console.log("WebSocket disconnected");
                updateStatus("Disconnected from server. Reconnecting...");
                clearInterval(socket.pingInterval);
                setTimeout(connect, 2000);
            };
            
            socket.onerror = (e) => {
                console.error("WebSocket error:", e);
                updateStatus("Connection error");
                socket.close();
            };
        }
        
        // Handle legacy message format
        function handleLegacyMessage(msg) {
            const { type, payload, timestamp } = msg;
            
            switch (type) {
                case 'CONNECTED':
                    console.log('Connected to server:', payload);
                    updateStatus('Connected to server');
                    break;
                    
                case 'LOGIN_SUCCESS':
                    console.log('Login successful:', payload);
                    break;
                    
                case 'GAME_CREATED':
                    console.log('Game created:', payload);
                    gameId = payload.gameId;
                    document.getElementById('game-id').textContent = `Game ID: ${gameId}`;
                    updateStatus(`Game created. Share ID ${gameId} with your opponent.`);
                    
                    // Join the game room
                    socket.send(JSON.stringify({ t: "JOIN", gameId }));
                    
                    // Enable/disable buttons
                    document.getElementById('create-game-btn').disabled = true;
                    document.getElementById('join-game-btn').disabled = true;
                    document.getElementById('join-game-id').disabled = true;
                    document.getElementById('resign-btn').disabled = false;
                    document.getElementById('offer-draw-btn').disabled = false;
                    break;
                    
                case 'GAME_JOINED':
                    console.log('Game joined:', payload);
                    gameId = payload.gameId;
                    document.getElementById('game-id').textContent = `Game ID: ${gameId}`;
                    updateStatus(`Joined game ${gameId}. Playing as ${payload.color}.`);
                    
                    // Join the game room
                    socket.send(JSON.stringify({ t: "JOIN", gameId }));
                    
                    // Enable/disable buttons
                    document.getElementById('create-game-btn').disabled = true;
                    document.getElementById('join-game-btn').disabled = true;
                    document.getElementById('join-game-id').disabled = true;
                    document.getElementById('resign-btn').disabled = false;
                    document.getElementById('offer-draw-btn').disabled = !isGameActive;
                    
                    isGameActive = true;
                    
                    // Set board orientation
                    const board = document.getElementById('board');
                    if (payload.color === 'black') {
                        board.setAttribute('orientation', 'black');
                    }
                    break;
                    
                case 'OPPONENT_JOINED':
                    console.log('Opponent joined:', payload);
                    updateStatus(`${payload.opponent} joined the game. Your turn.`);
                    isGameActive = true;
                    document.getElementById('offer-draw-btn').disabled = false;
                    break;
                    
                case 'GAME_OVER':
                    handleGameOver(payload);
                    break;
                    
                case 'DRAW_OFFERED':
                    console.log('Draw offered:', payload);
                    showDrawOfferPopup(payload.offeredBy);
                    updateStatus(`${payload.offeredBy} offered a draw.`);
                    break;
                    
                case 'DRAW_DECLINED':
                    console.log('Draw declined:', payload);
                    updateStatus(`${payload.declinedBy} declined the draw offer.`);
                    break;
                    
                case 'OPPONENT_DISCONNECTED':
                    console.log('Opponent disconnected:', payload);
                    updateStatus(`${payload.opponent} has disconnected.`);
                    
                    // Enable/disable buttons
                    document.getElementById('create-game-btn').disabled = false;
                    document.getElementById('join-game-btn').disabled = false;
                    document.getElementById('join-game-id').disabled = false;
                    document.getElementById('resign-btn').disabled = true;
                    
                    isGameActive = false;
                    break;
                    
                case 'ERROR':
                    console.error('Error from server:', payload);
                    updateStatus(`Error: ${payload.message}`);
                    break;
                    
                default:
                    console.log('Unknown message type:', type);
            }
        }
        
        // Update status message
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Add move to history
        function addMoveToHistory(move) {
            const moveListEl = document.getElementById('move-list');
            const moveItem = document.createElement('div');
            moveItem.textContent = move;
            moveListEl.appendChild(moveItem);
            
            // Scroll to bottom
            moveListEl.scrollTop = moveListEl.scrollHeight;
        }
        
        // Update server URL
        function updateServerUrl() {
            const serverUrlInput = document.getElementById('server-url');
            const newUrl = serverUrlInput.value.trim();
            
            if (newUrl) {
                localStorage.setItem('SERVER_URL', newUrl);
                
                // Close existing socket
                if (socket) {
                    if (socket.pingInterval) {
                        clearInterval(socket.pingInterval);
                    }
                    socket.close();
                }
                
                // Reconnect with new URL
                connect();
                
                // Hide settings
                document.getElementById('server-settings').style.display = 'none';
            }
        }
        
        // Show game result popup
        function showGameResultPopup(title, message) {
            document.getElementById('result-title').textContent = title;
            document.getElementById('result-message').textContent = message;
            const popup = document.getElementById('result-popup');
            popup.style.display = 'flex';
        }
        
        // Show draw offer popup
        function showDrawOfferPopup(opponent) {
            document.getElementById('draw-message').textContent = `${opponent} has offered a draw.`;
            const popup = document.getElementById('draw-popup');
            popup.style.display = 'flex';
        }
        
        // Check authentication status and redirect if needed
        function checkAuth() {
            const storedUser = localStorage.getItem('user');
            
            if (!storedUser) {
                // No user found, redirect to login page
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                user = JSON.parse(storedUser);
                username = user.username;
                
                // Update UI with user info
                document.getElementById('player-name').textContent = username;
                
                if (!user.isGuest && user.elo) {
                    document.getElementById('player-elo').textContent = `ELO: ${user.elo}`;
                    document.getElementById('elo-badge').textContent = user.elo;
                    
                    // Fetch latest user data
                    fetchUserData();
                    
                    // Fetch leaderboard
                    fetchLeaderboard();
                    
                    // Fetch match history
                    fetchMatchHistory();
                } else {
                    document.getElementById('player-elo').textContent = 'Guest Player';
                    document.getElementById('elo-badge').textContent = 'Guest';
                }
                
                return true;
            } catch (error) {
                console.error('Error parsing user data:', error);
                localStorage.removeItem('user');
                window.location.href = '/login.html';
                return false;
            }
        }
        
        // Fetch current user data
        async function fetchUserData() {
            if (user.isGuest) return;
            
            try {
                const response = await fetch(`${apiUrl}/me`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    
                    // Update user data
                    user.elo = userData.elo;
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Update UI
                    document.getElementById('player-elo').textContent = `ELO: ${user.elo}`;
                    document.getElementById('elo-badge').textContent = user.elo;
                } else {
                    // Handle authentication error
                    if (response.status === 401) {
                        // Try to refresh token
                        const refreshResponse = await fetch(`${apiUrl}/auth/refresh`, {
                            method: 'POST',
                            credentials: 'include'
                        });
                        
                        if (refreshResponse.ok) {
                            // Token refreshed, try again
                            fetchUserData();
                        } else {
                            // Refresh failed, redirect to login
                            localStorage.removeItem('user');
                            window.location.href = '/login.html';
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
        
        // Fetch leaderboard
        async function fetchLeaderboard() {
            try {
                const response = await fetch(`${apiUrl}/leaderboard?limit=10`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const leaderboardData = await response.json();
                    const leaderboardList = document.getElementById('leaderboard-list');
                    
                    // Clear existing items
                    leaderboardList.innerHTML = '';
                    
                    // Add new items
                    leaderboardData.forEach((player, index) => {
                        const item = document.createElement('li');
                        item.className = 'leaderboard-item';
                        
                        const rank = document.createElement('span');
                        rank.className = 'leaderboard-rank';
                        rank.textContent = `${index + 1}.`;
                        
                        const username = document.createElement('span');
                        username.className = 'leaderboard-username';
                        username.textContent = player.username;
                        
                        const elo = document.createElement('span');
                        elo.className = 'leaderboard-elo';
                        elo.textContent = player.elo;
                        
                        item.appendChild(rank);
                        item.appendChild(username);
                        item.appendChild(elo);
                        
                        leaderboardList.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
            }
        }
        
        // Fetch match history
        async function fetchMatchHistory() {
            if (user.isGuest) return;
            
            try {
                const response = await fetch(`${apiUrl}/matches/history?limit=10`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const matchHistory = await response.json();
                    const matchList = document.getElementById('match-list');
                    
                    // Clear existing items
                    matchList.innerHTML = '';
                    
                    if (matchHistory.length === 0) {
                        const item = document.createElement('li');
                        item.className = 'match-item';
                        item.textContent = 'No matches played yet';
                        matchList.appendChild(item);
                        return;
                    }
                    
                    // Add new items
                    matchHistory.forEach(match => {
                        const item = document.createElement('li');
                        item.className = 'match-item';
                        
                        const result = document.createElement('span');
                        result.className = `match-result ${match.result}`;
                        result.textContent = match.result.toUpperCase();
                        
                        const opponent = document.createElement('span');
                        opponent.className = 'match-opponent';
                        opponent.textContent = `vs ${match.opponent}`;
                        
                        const eloChange = document.createElement('span');
                        eloChange.className = `match-elo-change ${match.eloChange > 0 ? 'positive' : match.eloChange < 0 ? 'negative' : ''}`;
                        eloChange.textContent = match.eloChange > 0 ? `+${match.eloChange}` : match.eloChange;
                        
                        item.appendChild(result);
                        item.appendChild(opponent);
                        item.appendChild(eloChange);
                        
                        matchList.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Error fetching match history:', error);
            }
        }
        
        // Logout function
        function logout() {
            fetch(`${apiUrl}/auth/logout`, {
                method: 'POST',
                credentials: 'include'
            }).finally(() => {
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            });
        }
        
        // DOM ready handler
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded');
            
            // Check authentication
            if (!checkAuth()) return;
            
            // Show game screen
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            // Initialize WebSocket connection
            connect();
            
            // Tab switching
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabContent = document.getElementById(tab.dataset.tab);
                    tabContent.classList.add('active');
                });
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Server settings
            const settingsBtn = document.getElementById('settings-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
            const serverUrlInput = document.getElementById('server-url');
            
            settingsBtn.addEventListener('click', () => {
                serverUrlInput.value = getServerUrl();
                document.getElementById('server-settings').style.display = 'block';
            });
            
            saveSettingsBtn.addEventListener('click', updateServerUrl);
            
            cancelSettingsBtn.addEventListener('click', () => {
                document.getElementById('server-settings').style.display = 'none';
            });
            
            // Game result popup buttons
            document.getElementById('new-game-btn').addEventListener('click', () => {
                document.getElementById('result-popup').style.display = 'none';
                document.getElementById('create-game-btn').click();
            });
            
            document.getElementById('close-popup-btn').addEventListener('click', () => {
                document.getElementById('result-popup').style.display = 'none';
            });
            
            // Draw offer popup buttons
            document.getElementById('accept-draw-btn').addEventListener('click', () => {
                document.getElementById('draw-popup').style.display = 'none';
                if (socket && socket.readyState === WebSocket.OPEN && gameId) {
                    socket.send(JSON.stringify({ type: 'ACCEPT_DRAW', payload: { gameId } }));
                }
            });
            
            document.getElementById('decline-draw-btn').addEventListener('click', () => {
                document.getElementById('draw-popup').style.display = 'none';
                if (socket && socket.readyState === WebSocket.OPEN && gameId) {
                    socket.send(JSON.stringify({ type: 'DECLINE_DRAW', payload: { gameId } }));
                }
            });
            
            // Offer draw button
            document.getElementById('offer-draw-btn').addEventListener('click', () => {
                if (!gameId || !isGameActive) {
                    updateStatus('No active game');
                    return;
                }
                
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'OFFER_DRAW', payload: { gameId } }));
                    updateStatus('Draw offered to opponent');
                } else {
                    updateStatus('Not connected to server');
                }
            });
            
            // Game over handler with ELO update
            function handleGameOver(payload) {
                console.log('Game over:', payload);
                isGameActive = false;
                
                let message = '';
                let title = 'Game Over';
                
                if (payload.reason === 'checkmate') {
                    if (payload.winner === username) {
                        title = 'You Won!';
                        message = `You won by checkmate against ${payload.loser || 'opponent'}!`;
                    } else {
                        title = 'You Lost';
                        message = `${payload.winner} won by checkmate.`;
                    }
                } else if (payload.reason === 'resignation') {
                    if (payload.winner === username) {
                        title = 'You Won!';
                        message = `${payload.loser} resigned. You win!`;
                    } else {
                        title = 'You Lost';
                        message = `You resigned. ${payload.winner} wins.`;
                    }
                } else if (payload.reason === 'draw') {
                    title = 'Draw';
                    message = 'Game ended in a draw.';
                } else if (payload.reason === 'stalemate') {
                    title = 'Draw';
                    message = 'Game ended in stalemate.';
                } else if (payload.reason === 'draw_agreement') {
                    title = 'Draw';
                    message = 'Game ended by mutual agreement.';
                } else {
                    if (payload.winner === username) {
                        title = 'You Won!';
                        message = `You won against ${payload.loser || 'opponent'}!`;
                    } else {
                        title = 'You Lost';
                        message = `${payload.winner} won the game.`;
                    }
                }
                
                // If ELO change is included in the payload
                if (payload.eloChange !== undefined && !user.isGuest) {
                    const eloChange = payload.eloChange;
                    const newElo = payload.newElo || (user.elo + eloChange);
                    
                    // Update user ELO
                    user.elo = newElo;
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Update UI
                    document.getElementById('player-elo').textContent = `ELO: ${user.elo}`;
                    document.getElementById('elo-badge').textContent = user.elo;
                    
                    // Add ELO change to message
                    const eloChangeText = eloChange > 0 ? `+${eloChange}` : eloChange;
                    message += `\nELO change: ${eloChangeText}`;
                    
                    // Refresh leaderboard and match history
                    fetchLeaderboard();
                    fetchMatchHistory();
                }
                
                updateStatus(message);
                showGameResultPopup(title, message);
                
                // Enable/disable buttons
                document.getElementById('create-game-btn').disabled = false;
                document.getElementById('join-game-btn').disabled = false;
                document.getElementById('join-game-id').disabled = false;
                document.getElementById('resign-btn').disabled = true;
                document.getElementById('offer-draw-btn').disabled = true;
            }
            
            // Game control buttons
            const createGameBtn = document.getElementById('create-game-btn');
            const joinGameIdInput = document.getElementById('join-game-id');
            const joinGameBtn = document.getElementById('join-game-btn');
            const resetBtn = document.getElementById('reset-btn');
            const resignBtn = document.getElementById('resign-btn');
            
            createGameBtn.addEventListener('click', () => {
                if (!username) {
                    updateStatus('Please enter a username first');
                    return;
                }
                
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'CREATE_GAME', payload: {} }));
                } else {
                    updateStatus('Not connected to server');
                }
            });
            
            joinGameBtn.addEventListener('click', () => {
                if (!username) {
                    updateStatus('Please enter a username first');
                    return;
                }
                
                const joinGameId = joinGameIdInput.value.trim();
                
                if (!joinGameId) {
                    updateStatus('Please enter a game ID');
                    return;
                }
                
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'JOIN_GAME', payload: { gameId: joinGameId } }));
                    gameId = joinGameId;
                } else {
                    updateStatus('Not connected to server');
                }
            });
            
            resetBtn.addEventListener('click', () => {
                const board = document.getElementById('board');
                board.setAttribute('position', 'start');
                updateStatus('Board reset to starting position');
            });
            
            resignBtn.addEventListener('click', () => {
                if (!gameId) {
                    updateStatus('No active game');
                    return;
                }
                
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'RESIGN', payload: { gameId } }));
                } else {
                    updateStatus('Not connected to server');
                }
            });
            
            // Drag-drop â†’ send MOVE to server
            const board = document.getElementById('board');
            board.addEventListener('drop', (e) => {
                const { source, target, setAction } = e.detail;
                setAction('snapback'); // don't move locally; trust server STATE
                
                if (!socket || socket.readyState !== 1) {
                    updateStatus('Not connected to server');
                    return;
                }
                
                if (!gameId) {
                    // Allow moves in test mode
                    return;
                }
                
                socket.send(JSON.stringify({ 
                    t: "MOVE", 
                    gameId, 
                    from: source, 
                    to: target, 
                    promo: "q" 
                }));
            });
        });
    </script>
</body>
</html>
